require File.join(File.dirname(`node --print "require.resolve('expo/package.json')"`), "scripts/autolinking")
require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")

require 'json'
podfile_properties = JSON.parse(File.read(File.join(__dir__, 'Podfile.properties.json'))) rescue {}

def ccache_enabled?(podfile_properties)
  # Environment variable takes precedence
  return ENV['USE_CCACHE'] == '1' if ENV['USE_CCACHE']
  
  # Fall back to Podfile properties
  podfile_properties['apple.ccacheEnabled'] == 'true'
end

ENV['RCT_NEW_ARCH_ENABLED'] ||= '0' if podfile_properties['newArchEnabled'] == 'false'
ENV['EX_DEV_CLIENT_NETWORK_INSPECTOR'] ||= podfile_properties['EX_DEV_CLIENT_NETWORK_INSPECTOR']
ENV['RCT_USE_RN_DEP'] ||= '1' if podfile_properties['ios.buildReactNativeFromSource'] != 'true' && podfile_properties['newArchEnabled'] != 'false'
ENV['RCT_USE_PREBUILT_RNCORE'] ||= '1' if podfile_properties['ios.buildReactNativeFromSource'] != 'true' && podfile_properties['newArchEnabled'] != 'false'
platform :ios, podfile_properties['ios.deploymentTarget'] || '15.1'

prepare_react_native_project!

target 'ecolensmobile' do
  use_expo_modules!
  pod 'Executorch/Torch', '~> 0.2.0'

  if ENV['EXPO_USE_COMMUNITY_AUTOLINKING'] == '1'
    config_command = ['node', '-e', "process.argv=['', '', 'config'];require('@react-native-community/cli').run()"];
  else
    config_command = [
      'node',
      '--no-warnings',
      '--eval',
      'require(\'expo/bin/autolinking\')',
      'expo-modules-autolinking',
      'react-native-config',
      '--json',
      '--platform',
      'ios'
    ]
  end

  config = use_native_modules!(config_command)

  use_frameworks! :linkage => podfile_properties['ios.useFrameworks'].to_sym if podfile_properties['ios.useFrameworks']
  use_frameworks! :linkage => ENV['USE_FRAMEWORKS'].to_sym if ENV['USE_FRAMEWORKS']

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => podfile_properties['expo.jsEngine'] == nil || podfile_properties['expo.jsEngine'] == 'hermes',
    # An absolute path to your application root.
    :app_path => "#{Pod::Config.instance.installation_root}/..",
    :privacy_file_aggregation_enabled => podfile_properties['apple.privacyManifestAggregationEnabled'] != 'false',
  )

  post_install do |installer|
    react_native_post_install(
      installer,
      config[:reactNativePath],
      :mac_catalyst_enabled => false,
      :ccache_enabled => ccache_enabled?(podfile_properties),
    )

    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |build_configuration|
        # Ensure simulator builds are not fully excluded.
        build_configuration.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'i386'
      end
    end

    # ExecuTorch 0.2.0 ships device-only archives. Keep simulator free of these
    # flags and use a minimal set on device to avoid duplicate kernel registry
    # initialization aborts at startup.
    executorch_all_libs = %w[
      backend_coreml_ios
      backend_mps_ios
      backend_xnnpack_ios
      executorch_ios
      kernels_custom_ios
      kernels_optimized_ios
      kernels_portable_ios
      kernels_quantized_ios
    ]
    executorch_device_libs = %w[
      backend_xnnpack_ios
      executorch_ios
      kernels_portable_ios
    ]

    executorch_lib_pattern = executorch_all_libs.join('|')
    executorch_lib_regex = / -l"(?:#{executorch_lib_pattern})"/
    executorch_force_load_regex = / -force_load \$\(PODS_ROOT\)\/Executorch\/install\/lib\/lib(?:#{executorch_lib_pattern})\.a/
    target_support_files = File.join(installer.sandbox.root.to_s, 'Target Support Files', 'Pods-ecolensmobile')

    Dir.glob(File.join(target_support_files, 'Pods-ecolensmobile.*.xcconfig')).each do |xcconfig_path|
      xcconfig = File.read(xcconfig_path)
      ldflags_match = xcconfig.match(/^OTHER_LDFLAGS = (.+)$/)
      next if ldflags_match.nil?

      current_ldflags = ldflags_match[1]
      base_ldflags = current_ldflags
                    .gsub(executorch_lib_regex, '')
                    .gsub(executorch_force_load_regex, '')
      executorch_device_ldflags = executorch_device_libs.map { |lib| %( -l"#{lib}") }.join
      executorch_device_ldflags += executorch_device_libs.map { |lib|
        " -force_load $(PODS_ROOT)/Executorch/install/lib/lib#{lib}.a"
      }.join
      device_ldflags = base_ldflags + executorch_device_ldflags
      simulator_ldflags = base_ldflags

      xcconfig.sub!(/^OTHER_LDFLAGS = .+$/, "OTHER_LDFLAGS = #{simulator_ldflags}")
      xcconfig.gsub!(/^OTHER_LDFLAGS\[sdk=iphoneos\*\] = .+\n/, '')
      xcconfig.sub!(/^OTHER_LDFLAGS = .+$/, "\\0\nOTHER_LDFLAGS[sdk=iphoneos*] = #{device_ldflags}")

      File.write(xcconfig_path, xcconfig)
    end
  end
end
